# Viem Layer Implementation Plan

## Overview

Implement real blockchain service layers using viem.js to connect to the deployed smart contracts (CreditRegistry, ConsentManager, AuditLog). The key insight is that **only layers need to change** - all VM logic, UI components, and domain types remain unchanged.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                         UI Pages                             │
│  (dashboard, identity, consent, audit)                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    VM Layer (unchanged)                      │
│  WalletVM, IdentityVM, ConsentVM, AuditVM                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│               Service Interfaces (unchanged)                 │
│  WalletService, IdentityService, ConsentService, AuditService│
└─────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┴──────────────────┐
           ▼                                      ▼
┌─────────────────────┐              ┌─────────────────────────┐
│   Mock Layers       │              │   Viem Layers (NEW)     │
│   (existing)        │              │   - ViemClient          │
│   - *ServiceMock    │              │   - ContractConfig      │
└─────────────────────┘              │   - WalletServiceViem   │
                                     │   - IdentityServiceViem │
                                     │   - ConsentServiceViem  │
                                     │   - AuditServiceViem    │
                                     └─────────────────────────┘
```

## Contract Details

### Deployed Addresses (chain-31337 / localhost)
- ConsentManager: `0x5FbDB2315678afecb367f032d93F642f64180aa3`
- AuditLog: `0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0`
- CreditRegistry: `0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9`

### Contract → Service Mapping
| Contract | Service | Methods |
|----------|---------|---------|
| - (browser wallet) | WalletService | connect, disconnect, getAddress, isConnected, getChainId, ensureCorrectNetwork |
| CreditRegistry | IdentityService | register, update, get, getOption, has, getOwn, hasOwn |
| ConsentManager | ConsentService | grant, revokeById, revokeAll, isValid, getConsent, getBorrowerConsents, getOwnConsents |
| AuditLog | AuditService | getEntry, getLogsCount, getAccessHistory, getRecentLogs, getOwnAccessHistory |

## Implementation Tasks

### Phase 1: Infrastructure Setup

#### 1.1 Install viem dependency
```bash
bun add viem
```

#### 1.2 Create Contract ABIs
Create `lib/blockchain/contracts/abis.ts` with typed ABIs for:
- CreditRegistry (from ignition artifacts)
- ConsentManager (from ignition artifacts)
- AuditLog (from ignition artifacts)

#### 1.3 Create Contract Config Service
Create `lib/blockchain/services/ContractConfig.ts`:
```typescript
interface ContractConfig {
  readonly creditRegistry: { address: Address; abi: Abi }
  readonly consentManager: { address: Address; abi: Abi }
  readonly auditLog: { address: Address; abi: Abi }
}

const ContractConfig = Context.GenericTag<ContractConfig>("@blockchain/ContractConfig")
```

#### 1.4 Create Viem Client Service
Create `lib/blockchain/services/ViemClient.ts`:
```typescript
interface ViemClient {
  readonly publicClient: PublicClient
  readonly walletClient: WalletClient | null
  readonly setWalletClient: (client: WalletClient) => void
}

const ViemClient = Context.GenericTag<ViemClient>("@blockchain/ViemClient")
```

### Phase 2: Wallet Service Implementation

#### 2.1 Create WalletServiceViem
`lib/blockchain/layers/WalletServiceViem.ts`

Implementation approach:
- Use `window.ethereum` for browser wallet connection
- Create `WalletClient` from viem with `custom` transport
- Store connected address in Effect Ref
- Chain ID validation against expected network (31337 for local, or mainnet/testnet)

Key methods:
- `connect`: Request accounts via `eth_requestAccounts`, create walletClient
- `disconnect`: Clear walletClient reference
- `getAddress`: Return cached address or fail
- `isConnected`: Check if walletClient exists
- `getChainId`: Query `eth_chainId`
- `ensureCorrectNetwork`: Compare chainId, potentially request switch

### Phase 3: Contract Service Implementations

#### 3.1 Create IdentityServiceViem
`lib/blockchain/layers/IdentityServiceViem.ts`

Contract methods to call:
- `registerIdentityAttributes(emailHash, creditTier, incomeBracket, debtRatioBracket, accountReferenceHash)`
- `updateIdentityAttributes(emailHash, creditTier, incomeBracket, debtRatioBracket)`
- `getIdentityAttributes(user)` → IdentityAttributes
- `hasIdentityAttributes(user)` → bool

Service method mapping:
| Service Method | Contract Call | Notes |
|----------------|---------------|-------|
| register | registerIdentityAttributes | Write, needs wallet |
| update | updateIdentityAttributes | Write, needs wallet |
| get | getIdentityAttributes | Read |
| getOption | getIdentityAttributes + catch | Read, wrap in Option |
| has | hasIdentityAttributes | Read |
| getOwn | get(walletAddress) | Needs WalletService |
| hasOwn | has(walletAddress) | Needs WalletService |

#### 3.2 Create ConsentServiceViem
`lib/blockchain/layers/ConsentServiceViem.ts`

Contract methods to call:
- `grantConsent(lender, scopes, durationSeconds)` → bytes32
- `revokeConsentById(consentId)`
- `revokeAllConsents(lender)`
- `isConsentValid(consentId)` → bool
- `consents(consentId)` → Consent struct (via mapping getter)
- `getScopes(consentId)` → bytes32[]
- `getBorrowerConsents(borrower)` → bytes32[]

Service method mapping:
| Service Method | Contract Call | Notes |
|----------------|---------------|-------|
| grant | grantConsent | Write |
| revokeById | revokeConsentById | Write |
| revokeAll | revokeAllConsents | Write |
| isValid | isConsentValid | Read |
| getConsent | consents + getScopes | Read, combine results |
| getBorrowerConsents | getBorrowerConsents | Read |
| getOwnConsents | getBorrowerConsents(self) + map getConsent | Needs WalletService |

#### 3.3 Create AuditServiceViem
`lib/blockchain/layers/AuditServiceViem.ts`

Contract methods to call:
- `getAuditEntry(entryId)` → AuditEntry
- `getLogsCount()` → uint256
- `getAccessHistory(user)` → uint256[]
- `getRecentLogs(count)` → AuditEntry[]

Service method mapping:
| Service Method | Contract Call | Notes |
|----------------|---------------|-------|
| getEntry | getAuditEntry | Read |
| getLogsCount | getLogsCount | Read |
| getAccessHistory | getAccessHistory | Read |
| getRecentLogs | getRecentLogs | Read |
| getOwnAccessHistory | getAccessHistory(self) + map getEntry | Needs WalletService |

### Phase 4: Layer Composition

#### 4.1 Create combined Viem layer
`lib/blockchain/layers/Viem.ts`

```typescript
// Config layer for different environments
export const ContractConfigLocal = Layer.succeed(ContractConfig, {
  creditRegistry: { address: "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9", abi: CreditRegistryAbi },
  consentManager: { address: "0x5FbDB2315678afecb367f032d93F642f64180aa3", abi: ConsentManagerAbi },
  auditLog: { address: "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0", abi: AuditLogAbi },
})

// ViemClient layer (depends on being in browser)
export const ViemClientLive = Layer.effect(ViemClient, Effect.gen(function* () {
  // Create public client for reads
  // Create wallet client on connect
}))

// Service layers
export const WalletServiceViem = Layer.effect(WalletService, ...)
  .pipe(Layer.provide(ViemClientLive))

export const IdentityServiceViem = Layer.effect(IdentityService, ...)
  .pipe(Layer.provide(ViemClientLive), Layer.provide(ContractConfigLocal))

// ... same for Consent and Audit

// Combined layer for all services
export const AllServicesViem = Layer.mergeAll(
  WalletServiceViem,
  IdentityServiceViem,
  ConsentServiceViem,
  AuditServiceViem
)
```

### Phase 5: Integration

#### 5.1 Environment-based layer selection
Create `lib/blockchain/layers/index.ts`:
```typescript
// Export both mock and viem layers
export * from "./Mock"
export * from "./Viem"

// Helper to select based on environment
export const getServicesLayer = () => {
  if (process.env.NEXT_PUBLIC_USE_MOCK === "true") {
    return AllServicesMock
  }
  return AllServicesViem
}
```

#### 5.2 Update page layer composition
Pages can switch between mock and viem layers:
```typescript
// For development with mocks
const layer = WalletVMLive.layer.pipe(Layer.provide(WalletServiceMock))

// For real blockchain
const layer = WalletVMLive.layer.pipe(Layer.provide(WalletServiceViem))
```

## File Structure

```
lib/blockchain/
├── contracts/
│   └── abis.ts              # NEW: Contract ABIs
├── domain/
│   └── ... (unchanged)
├── services/
│   ├── ContractConfig.ts    # NEW: Contract addresses/ABIs
│   ├── ViemClient.ts        # NEW: Viem client service
│   └── ... (unchanged interfaces)
├── layers/
│   ├── Mock.ts              # (existing)
│   ├── WalletServiceViem.ts # NEW
│   ├── IdentityServiceViem.ts # NEW
│   ├── ConsentServiceViem.ts  # NEW
│   ├── AuditServiceViem.ts    # NEW
│   ├── Viem.ts              # NEW: Combined viem layer
│   └── index.ts             # NEW: Layer exports
└── errors.ts                # (unchanged)
```

## Error Handling

Map viem errors to our domain errors:
- `ContractFunctionRevertedError` → `ContractCallError`
- `UserRejectedRequestError` → `WalletError` (user declined)
- `ChainMismatchError` → `WrongNetworkError`
- Not found patterns → `*NotFoundError`

## Testing Strategy

1. **Unit tests**: Test each viem layer with mocked viem clients
2. **Integration tests**: Test against local Hardhat node
3. **E2E**: Full flow with real wallet connection

## Design Decisions

1. **Network Support**: Local only (chain 31337) for now
2. **Transaction Tracking**: Full tracking via ADT (Pending → Confirming → Confirmed | Failed)
3. **Wallet Persistence**: Use `KeyValueStore` from `@effect/platform` with `layerMemory` for now

## Transaction Status ADT

```typescript
type TransactionStatus = Data.TaggedEnum<{
  Idle: {}
  Pending: { readonly hash: Hash }
  Confirming: { readonly hash: Hash; readonly confirmations: number }
  Confirmed: { readonly hash: Hash; readonly receipt: TransactionReceipt }
  Failed: { readonly hash: Hash; readonly reason: string }
}>

const TransactionStatus = Data.taggedEnum<TransactionStatus>()
```

## Additional Infrastructure

### KeyValueStore for Wallet State
```typescript
// Store last connected address for potential reconnection
const WalletStore = KeyValueStore.make("wallet")

// In WalletServiceViem:
// - On connect: store address
// - On disconnect: clear
// - On init: check for stored address and attempt reconnect
```

## Implementation Order

1. Install dependencies (`viem`, ensure `@effect/platform` is available)
2. Create ABIs from ignition artifacts
3. Create ContractConfig + ViemClient services
4. Create TransactionStatus ADT
5. Implement WalletServiceViem (with KeyValueStore)
6. Implement IdentityServiceViem
7. Implement ConsentServiceViem
8. Implement AuditServiceViem
9. Create combined Viem layer
10. Test with local Hardhat node
